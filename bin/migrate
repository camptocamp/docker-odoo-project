#!/bin/bash
set -e

if ! PGPASSWORD=$DB_PASSWORD psql -lqtA -h $DB_HOST -U $DB_USER | grep -q "^$DB_NAME|"; then
  PGPASSWORD=$DB_PASSWORD createdb -h $DB_HOST -U $DB_USER -O $DB_USER $DB_NAME
fi

CONFIGFILE=/odoo/migration.yml
MARABUNTA_DB_HOST=$DB_HOST \
  MARABUNTA_DATABASE=$DB_NAME \
  MARABUNTA_DB_USER=$DB_USER \
  MARABUNTA_DB_PASSWORD=$DB_PASSWORD \
  MARABUNTA_DB_PORT=$DB_PORT \
unbuffer marabunta --migration-file $CONFIGFILE
